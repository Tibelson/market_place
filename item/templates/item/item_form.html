{% extends 'market/base.html' %}

{% block title %}Create Item | Campus Connect{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <div class="bg-white shadow-lg rounded-2xl overflow-hidden">
    <div class="p-6 border-b">
      <h1 class="text-2xl font-bold">List a new item</h1>
      <p class="text-sm text-gray-500 mt-1">Fill in details below to post your item to the campus marketplace.</p>
    </div>

    <form method="post" action="" enctype="multipart/form-data" id="item-form" class="p-6 space-y-6">
      {% csrf_token %}

      {# show Django form errors if passed as `form` #}
      {% if form.errors %}
      <div class="border-l-4 border-red-500 bg-red-50 p-3 text-sm text-red-700">
        <strong class="block font-semibold">Please fix the following errors:</strong>
        <ul class="mt-2 list-disc list-inside">
          {% for field, errors in form.errors.items %}
            {% for error in errors %}
              <li>{{ error }}</li>
            {% endfor %}
          {% endfor %}
          {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Item name</label>
          <input name="name" required class="mt-1 block w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-400" placeholder="e.g. Calculus textbook (3rd ed.)" value="{{ form.name.value|default_if_none:'' }}" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Price (USD)</label>
          <input name="price" required type="number" step="0.01" min="0" class="mt-1 block w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-400" placeholder="0.00" value="{{ form.price.value|default_if_none:'' }}" />
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Category</label>
        <select name="category" class="mt-1 block w-64 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-400">
          <option value="">Uncategorized</option>
          {% if categories %}
            {% for cat in categories %}
              <option value="{{ cat.id }}" {% if form.category.value|stringformat:'s' == cat.id|stringformat:'s' %}selected{% endif %}>{{ cat.name }}</option>
            {% endfor %}
          {% endif %}
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Photos</label>
        <div class="mt-2 flex items-center gap-4">
          <label class="inline-flex items-center justify-center px-4 py-2 bg-gray-50 border border-dashed rounded-lg cursor-pointer hover:bg-gray-100">
            <input type="file" name="image" accept="image/*" id="image-input" class="hidden" />
            <svg class="w-5 h-5 text-gray-500 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V8m0 0l5-5 5 5M7 8h10"/></svg>
            <span class="text-sm text-gray-700">Upload a photo</span>
          </label>

          <div id="image-preview" class="w-32 h-32 bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center text-gray-400">
            <span class="text-xs">No image</span>
          </div>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Description</label>
        <textarea name="description" rows="6" class="mt-1 block w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-400" placeholder="Add details about the condition, edition, pickup/delivery options...">{{ form.description.value|default_if_none:'' }}</textarea>
      </div>

      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <label class="inline-flex items-center">
            <input type="checkbox" name="is_sold" class="form-checkbox text-teal-600" {% if form.is_sold.value %}checked{% endif %}/> 
            <span class="ml-2 text-sm text-gray-700">Mark as sold</span>
          </label>
        </div>

        <div class="flex items-center gap-3">
          <a href="{% url 'market:index' %}" class="text-sm text-gray-600">Cancel</a>
          <button type="submit" class="px-6 py-3 bg-teal-600 text-white rounded-lg font-medium hover:bg-teal-700">Publish item</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const input = document.getElementById('image-input');
  const preview = document.getElementById('image-preview');

  input && input.addEventListener('change', function (e) {
    const file = e.target.files && e.target.files[0];
    if (!file) {
      preview.innerHTML = '<span class="text-xs">No image</span>';
      return;
    }
    if (!file.type.startsWith('image/')) {
      preview.innerHTML = '<span class="text-xs text-red-500">Invalid file</span>';
      return;
    }
    const reader = new FileReader();
    reader.onload = function (ev) {
      preview.innerHTML = `<img src="${ev.target.result}" class="object-cover w-full h-full" alt="preview"/>`;
    };
    reader.readAsDataURL(file);
  });

  // client-side validation
  const form = document.getElementById('item-form');
  form && form.addEventListener('submit', function (e) {
    const name = form.querySelector('input[name=name]').value.trim();
    const price = parseFloat(form.querySelector('input[name=price]').value);
    if (!name) {
      e.preventDefault(); alert('Please add an item name.'); return false;
    }
    if (isNaN(price) || price < 0) {
      e.preventDefault(); alert('Please enter a valid price (>= 0).'); return false;
    }
  });
});
</script>

{% endblock %}
